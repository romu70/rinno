---
import { Image } from "astro:assets";
import chevronIcon from "../../assets/chevron.svg";

// Accordion component - content block with collapsible/expandable behavior
interface Props {
  title: string;
  defaultOpen?: boolean;
  id?: string;
  headingLevel?: 'h2' | 'h3' | 'h4';
}

const { title, defaultOpen = false, id, headingLevel = 'h4' } = Astro.props;
const sectionId =
  id || `collapsible-${Math.random().toString(36).substr(2, 9)}`;
const HeadingTag = headingLevel;
---

<section class="accordion" data-section-id={sectionId}>
  <button
    class="section-header"
    aria-expanded={defaultOpen}
    aria-controls={`${sectionId}-content`}
  >
    <Image src={chevronIcon} alt="" class="chevron" aria-hidden="true" />
    <HeadingTag>{title}</HeadingTag>
  </button>
  <div
    class="section-content"
    id={`${sectionId}-content`}
    data-default-open={defaultOpen}
  >
    <div class="section-content-inner">
      <slot />
    </div>
  </div>
</section>

<style>
  .accordion {
    padding: 0;
    border-radius: var(--radius);
    transition:
      background-color 0.3s ease,
      padding 0.3s ease;
  }

  .accordion[data-expanded="true"] {
    background-color: hsla(var(--hue), 40%, 90%, 0.6);
    padding: 1.5rem;
  }

  .collapsible-section {
    background-color: transparent;
    border-radius: var(--radius);
  }

  .section-header {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 1rem;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    text-align: left;
  }

  .section-header h2,
  .section-header h3,
  .section-header h4 {
    margin: 0;
    color: var(--color-darkest);
  }

  .chevron {
    width: 1rem;
    height: 1rem;
    transform: rotate(180deg);
    transition: transform 0.3s ease, color 0.2s ease;
    flex-shrink: 0;
    color: var(--color);
  }

  .section-header:hover .chevron {
    color: var(--color);
  }

  .section-header[aria-expanded="true"] .chevron {
    transform: rotate(0deg);
  }

  .section-content {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transition:
      max-height 0.4s ease,
      opacity 0.3s ease;
  }

  .section-content[data-default-open="true"] {
    max-height: 5000px;
    opacity: 1;
  }

  .section-content-inner {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
  }

  /* Columns get equal space, max 2 per row */
  .section-content-inner > :global(.column) {
    flex: 1 1 40%;
  }

  /* Non-column content takes full width */
  .section-content-inner > :global(:not(.column)) {
    flex: 1 1 100%;
  }

  @media (max-width: 768px) {
    .accordion[data-expanded="true"] {
      padding: 1rem;
    }

    /* Stack columns vertically on mobile */
    .section-content-inner > :global(.column) {
      flex: 1 1 100%;
    }

    .chevron {
      width: 1rem;
      height: 1rem;
    }

    .section-content,
    .section-content-inner {
      gap: 1rem;
    }
  }

  @media (min-width: 1440px) {
    .accordion[data-expanded="true"] {
      padding: 2rem;
    }

    .chevron {
      width: 1.1rem;
      height: 1.1rem;
    }

    .section-content,
    .section-content-inner {
      gap: 2rem;
    }
  }
</style>

<script>
  // Handle collapsible sections
  document.addEventListener("DOMContentLoaded", () => {
    const sections = document.querySelectorAll(".accordion");

    sections.forEach((section) => {
      const button = section.querySelector(".section-header") as HTMLElement;
      const content = section.querySelector(".section-content") as HTMLElement;

      if (!button || !content) return;

      button.addEventListener("click", () => {
        const isExpanded = button.getAttribute("aria-expanded") === "true";

        // Toggle aria-expanded
        button.setAttribute("aria-expanded", (!isExpanded).toString());

        // Toggle background on accordion wrapper
        if (isExpanded) {
          section.removeAttribute("data-expanded");
          content.style.maxHeight = "0";
          content.style.opacity = "0";
        } else {
          section.setAttribute("data-expanded", "true");
          content.style.maxHeight = "5000px";
          content.style.opacity = "1";
        }
      });
    });
  });
</script>
